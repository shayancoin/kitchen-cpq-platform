---
alwaysApply: false
description: >
  Govern how the Rust-based geometry-kernel is structured, compiled to WASM, and
  consumed by TypeScript services and the 3D client.
globs:
  - "packages/geometry-kernel/src/**/*.rs"
  - "packages/geometry-kernel/pkg/**/*.{ts,js}"
  - "services/param-kernel-service/src/**/*.ts"
---

# Rust / WASM Geometry Kernel Workflow

The Rust geometry kernel is the authoritative implementation of parametric
The Rust geometry kernel is the authoritative implementation of parametric
geometry operations.

## 1. Rust Module Layout

- `src/lib.rs`:
  - Public API boundary: functions exposed to JS/WASM.
- Submodules:
  - `kernel/`: core geometry & topology operations.
  - `constraints/`: geometric and configuration constraints.
- No business logic (pricing, orders) is allowed in Rust.

## 2. WASM Boundary

- Use `wasm-pack`/`wasm-bindgen` to generate bindings:
  - Expose **small, composable** functions (e.g. `apply_delta`, `validate_state`):
    - Max function size: ≤ 150 lines (per clippy guidelines).
    - Max cyclomatic complexity: ≤ 10.
  - Deterministic for given inputs (logical determinism, not bit-for-bit):
    - Same input must yield the same geometry result ±1e-6 units.
    - Use exact predicates (e.g., orientation tests) or adaptive filtering for robustness.
    - Document any non-deterministic components (solver randomization, if present).
  - Accept/return JSON strings or well-defined FFI structs, not ad-hoc blobs.
- Ensure all exported functions are:
  - Pure (no global mutable state).
  - Deterministic for given inputs.

## 3. Consumption Patterns

- Front-end (3D configurator):
    Calls the same Rust logic natively or via WASM, then wraps results in gRPC
    responses (`ParametricKernelService`).
- Backend (`param-kernel-service`):
  - Calls the same Rust logic natively or via WASM, then wraps results in gRPC
    responses (`ParametricKernelService`).  

- Add at least one test that:
  - Loads the WASM module in a Node environment (via wasm-bindgen generated loader).
  - Invokes `apply_delta(current_state, delta)` with a known input.
  - Asserts output matches a golden fixture (or computed reference) within tolerance.
  - Example: delta applied to a 2x2 grid → verify cabinet positions within ±1mm.
- Add at least one test that:
  - Loads the WASM module in a Node environment.
  - Verifies a roundtrip call (`apply_delta`, `validate_design`) returns expected data.
