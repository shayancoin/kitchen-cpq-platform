---
alwaysApply: false
description: >
  Standardize tracing, metrics, and logging using the instrumentation-otel library
  across all TypeScript services.
globs:
  - "services/**/src/**/*.ts"
  - "libs/instrumentation-otel/src/**/*.ts"
  - "libs/shared-*/src/**/*.ts"
---

# Observability & OpenTelemetry

All TypeScript services must use the shared OpenTelemetry helpers in
`libs/instrumentation-otel` for tracing, metrics, and structured logging.  

## 1. Tracing

- Every externally reachable handler **must** start or join a span. “External” means: any HTTP endpoint in `apps/api` (tRPC and REST), any publicly exposed gRPC handler in NestJS services, any Temporal workflow/activity invoked by external or cross-service triggers, and any message/queue consumer that accepts requests from outside the service boundary. Internal-only helpers (private functions, internal cron jobs) are exempt but should propagate spans if they call remote services.
- Span naming convention:
  - `ServiceName.MethodName` (e.g. `ConfiguratorSession.ApplyDelta`,
    `Cpq.PriceDelta`, `CadCam.GenerateArtifacts`).
- Attach these attributes whenever available:
  - `tenant.id`, `user.id`, `project.id`, `quote.id`, `workflow.id`.
- Do **not** record sensitive data (emails, JWTs, raw CNC code) in span attributes.

## 2. Metrics

- Use the shared metrics helpers for:
  - Request latency histograms, tagged by `{service, method}`.
  - Error counters with `{service, method, error_code}`.
  - Background job timings (Temporal activities, batch jobs).
- For endpoints with explicit budgets (see performance rule), define metrics with
  bucket boundaries that make P95/P99 easy to monitor.

## 3. Logging

- Use the shared logger from `instrumentation-otel` instead of ad‑hoc `console.log`.
- All logs must be:
  - Structured JSON.
  - Correlated with traces via `trace_id` / `span_id`.
- Log at correct levels:
  - `info` for normal business events.
  - `warn` for recoverable anomalies.
  - `error` only for failures that impact correctness or UX.

## 4. New Service Checklist

When creating a new service under `services/`:

1. Wire the OpenTelemetry SDK from `libs/instrumentation-otel`.
2. Add basic HTTP/gRPC middleware to start spans and record latency.
3. Expose:
   - `/health` endpoint (HTTP 200 if service is operational).
   - `/metrics` endpoint (Prometheus exposition format) for internal scraping.
   - OTLP gRPC exporter (optional, for centralized tracing backend).
4. Add a minimal Grafana dashboard for the service (latency, errors, throughput).
